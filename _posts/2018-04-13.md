# Tinman



## Overview

```tinman``` : 테스트넷을 구축하기 위한 스크립트 모음입니다. ```tinman``` 테스트넷은 모든, 또는 일부의 사용자 계정이 메인 네트워크로부터 쉽게 이식될 수 있도록합니다.



## Tinman 명령어

- **```tinman snapshot```** : 테스트넷의 오프라인 초기화를 위해 필요한 데이터 *(*계정이나 다른 데이터들*)*를 블록체인에서 가져오는 명령어


- **```tinman txgen```**  :  ```snapshot.py``` 의 출력*(output)* 을 일련의 작업*(*명령어*)*으로 변환하여 테스트넷의 오프라인 초기화를 수행하는 명령어

- **```tinman keysub```** : 비밀키를 일련의 작업 *actions* (명령어) 리스트로 대체하는 명령어

- **```tinman submit```** : 테스트넷 노드에  ```txgen.py``` 의 *output*을 전송하는 명령어

  ​

## Tinman Installation (설치)

### Creating a virtualenv(가상환경 구축)

------

이 단계에서 우리는 운영체제에 설치되어있는 *Python*과 현재 우리 프로젝트에 쓰이는 Python을 분리시키기 위해 가상 환경을 만들 것입니다. 가상환경이 활성화되어 (*activated*) ```activate``` 스크립트를 소스로하여 현재 쉘 프롬프트와 ```PATH```를 수정합니다.

```
sudo apt-get install virtualenv python3
virtualenv -p $(which python3) ~/ve/tinman\
source ~/ve/tinman/bin/activate
```

### Using tinman

------

```tinman``` 소스는 ```git```으로 관리됩니다. 이 문서는 소스 코드가 ```~/src/tinman```에 있다고 가정합니다.

```
mkdir -p ~/src
cd ~/src
git clone git@github.com:steemit/tinman
pip install ./tinman
```

*git clone 시 tinman 디렉토리 내부에 있는 simple_steem_client 디렉토리까지 clone이 안된다면, simple_steem_client git에서 clone 필요*



제대로 설치가 되었다면, ```tinman --help``` 를 통해 실행 가능한 명령어를 볼 수 있습니다.

```
# Execute inside tinman virtualenv
tinman --help
```

 참고)```~/ve/tinman/bin/tinman``` 내의  ```tinman``` 스크립트는 어딘가에 심볼릭 링크 되어있습니다.

(예를들어, ```ln -s ~/ve/tinman/bin/tinman ~/bin/tinman```  은 ```tinman``` 이 ```virtualenv``` 를 activate하지 않고도 실행될 수 있게 합니다. )



## Example Usage

이 부분에는 하나의 큰 예제가 포함되어 있습니다.

### Mainnet steemd

---

먼저*,* 메인 네트워크를 위한 ```steemd```를 설치해야 합니다. 이 ```steemd```는 다음과 같은 특성이 있습니다 :

- ```steemd```는 ```appbase``` 버전이어야함
- ```chain```, ```webserver```, ```database_api``` 플러그인은 이용 가능해야 함
- 이 예제에서 ```webserver-http-endpoint```는 ```127.0.0.1:8090``` 이라고 가정
- 명확한 단일 point에서의 snapshot이 필요한 경우, seed node가 사용될 필요가 없으므로, p2p 네트워크에 연결하지 않습니다.

### Taking a snapshot

---

```
tinman snapshot -s http://127.0.0.1:8090 -o snapshot.json
```

 이 문서를 작성 했을 때, 위의 명령어 실행 시 500,000줄에 해당하는 1GB 의 JSON 파일을 만들며 대략 5분 정도 걸렸습니다. 만약 ```tinman snapshot``` 을 쌍방향으로 실행중이라거나, 시각적으로 진행 상황을 보고 싶다면, ```pv``` 프로그램 (```apt-get install pv```) 를 설치하고 사용하면 됩니다.

``` 
tinman snapshot -s <http://127.0.0.1>:8090 | pv -l > snapshot.json
```



## Generating actions

이제 snapshot 을 찍었으므로,  ```tinman txgen```을 이용하여 명령어 리스트를 생성할 수 있습니다. 명령어에는 계좌(계정)에 돈을 지급하는 트랜잭션과 트랜잭션 발생 속도를 제어하는 wait-for-block 명령어가 포합됩니다.

```
# As of this writing, this command takes ~10 minutes, consumes ~4GB of RAM
tinman txgen -c txgen.conf -o tn.txlist
```

```tinman txgen``` 에 대한 유의사항 :

- 모든 계좌는 ```porter``` 를 추가적인 권한으로 가지고 있습니다. ```porter```는 테스트넷을 만든 사람이 테스트넷에서 어떤 계정이든 접근 가능하게 해줍니다.

- ```porter```에 대한 개인키와 다른 계좌는 *config* 파일의 ```secret``` 옵션에 기반하여 결정적으로 (deterministically) 만들어집니다.

- 잔고 (balance)는 실시간 STEEM과 vesting 간 ```total_port_balance``` 를 나누어 생성되며, ```min_vesting_per_account``` 에 따라 달라질 수 있습니다.

- 그래서, 테스트넷 잔고와 메인넷 잔고는 달라집니다.  테스트넷 잔고는 메인넷 잔고에 비례하게 됩니다.

- ```txgen.conf``` 에 나열된 계좌는 system accounts 로 고려되며, snapshot 내 동일한 이름의 계좌(계정)은 복사(이식)되지 않습니다.

  ​

## Keys substitution

```tinman``` 툴의 문제를 분리하기위해, ```tinman txgen``` 툴은 개인키를 포함하고있는 트랜잭션을 직접 생성하지 않습니다.

(```STEEM_INIT_PRIVATE_KEY``` WIF , ```5JNHfZYKGaomSFvd4NUdQ9qMcEAC43kujbfjueTHpVapX1Kzq2n``` 를 제외)

대신, ```publickey:active-porter``` 와 같은 *key string*이 ```porter``` 계좌의 실제 공개키 자리에 들어가게 됩니다.

트랜잭션이 임의의 사용자 특성화된 데이터를 포함할 수 있으므로, 고정된 escape sequence를 사용하면 특정 사용자에 대한 데이터가 나타날 수 있습니다. 따라서, 고정된 escape sequence는 키 스트링의 범위를 정하는데 쓰일 수 없습니다. 대신, 가변의 escape sequence (데이터에 나타나지않는 짧은 변수)가 도입되었고 ```"esc"``` 값에 저장됩니다.

따라서, 키를 알고있는 프로그램은 트랜잭션이 네트워크로 전송되기 전에 키를 교체 해야합니다. 이게 키 교체 툴인 ```tinman keysub ``` 의 역할입니다. ```tinman keysub``` 는 명령어들의 리스트를 input으로 받고, 특정한 키를 생성하며, 각 키를 명령어로 대체합니다.

### Deriving secret keys

----

기본적으로, ```tinman keysub``` 로 생성된 개인키는 *seed string* 을 알고있습니다. 그러나, ```set_secret``` 을 ```tinman keysub``` 에 추가하여 *(구문을 덧붙여)* secret을 각 *seed string*에 덧붙일 수 있습니다.

### Command-line key generator

---

```steemd```와 함께 제공된 ```get_dev_key``` 프로그램도 ```tinman keysub``` 이 쓰는 키 유도 알고리즘을 이용하여 키를 유도해냅니다.



## Running testnet fastgen node

트랜잭션들이 생성되었으므로, 이제는 테스트넷을 초기화하는데 사용해봅시다. 많은 블록 가치의 트랜잭션이 만들어졌기 때문에, ```tinman submit``` 은 ```debug_node_plugin``` 을 사용하여 가능한 한 빨리 과거의 블록을 생성하기 위해 블록 대기(block wait)를 구현합니다. 그래서, 우리는 특별한 노드를 실행시킬건데, debug plugin 이 가능한 그 노드를 **''fastgen node''** 라고 부릅시다.

fastgen node는 단지 네트워크를 초기화하기 위해서만 이용됩니. (fastgen 이라고 불리는 이유는, 각각의 블록 사이에서 실제 시간 3초를 기다리는 것보다 블록을 가능한 한 빨리 생성하기 때문입니다.) 이후에, 하나 또는 그 이상의 일반적인 witness node들이 p2p 형태로 fastgen node에 연결할 것이고, 블록을 가져오거나, 블록 생성을 시작할 것입니다.



fastgen node는 다음의 조건들이 필요합니다.

- ```steemd``` 는 ```appbase``` 버전이어야만 함
- 테스트넷 ```blockchain``` 디렉토리는 비워져있어야 함 ( 비어있지 않다면,  ```rm -Rf testnet_datadir/blockchain```)
- 다음의 플러그인들이 필요함 (호출 가능해야함) : ```chain p2p webserver debug_node database_api network_broadcast_api debug_node_api block_api```  
- ```webserver-http-endpoint``` 는 ```127.0.0.1:9990``` 이라고 가정함
- steemit/steem - Issues #1722, #1723의 기능을 포함해야 함
- p2p listen을 할 수 있어야함, 아래의 예제는  ```0.0.0.0:12001``` 으로 listenig 중이라고 가정 

 테스트넷에서, 몇몇의 직렬화는 메인네트워크와 다르고, *steem_python* 에 의해 직렬화가 수행되어지지 않습니다.

그러므로, ```tinman submit``` 은 트랜잭션의 서명을 ```steemd``` 에 포함된  ```sign_transaction``` 에게 위탁합니다.



## Pipelining transactions to testnet

```
( \
	echo '["set_secret", {"secret" : "xyz-"}]' ; \
	tinman txgen -c txgen.conf \
) | \
tinman keysub | \
tinman submit -t http://127.0.0.1:9990 --signer steem/programs/util/sign_transaction -f fail.json
```



## Running testnet witness node(s)

트랜잭션이 전송된 후에, ```tinman txgen``` 이 ```init-0```부터 ```init-20```까지의 witness를 만들고 많은 양의 ```TESTS``` 를 선발된 witness에게 투표합니다. 이 witness node의 키는 ```get_dev_key``` 프로그램과 비교하여 결정적 알고리즘에 의해 생성됩니다. 따라서, witness들의 key는 다음을 포함합니다 : 

```
programs/util/get_dev_key xxx- block-init-0:21
```

```xxx``` 가 ```txgen.conf``` 내의 문자열 ```“secret”``` 입니다.

따라서 initial node 에서 벗어나 블록 생성 업무로 변경하려면, witness node를 정확한 블록 생성 설정과 연결해야 합니다. 각 witness node는 config 파일의 ```p2p-seed-node``` 옵션을 사용하여 fastgen node를 명시해야 합니다. 

그러므로 witness config 파일에 witness 에 대한 정의와 개인키를 추가하게 됩니다.

```
i=0; while [ $i -lt 21 ] ; do echo witness = '"'init-$i'"' >> testnet_datadir/config.ini ; let i=i+1 ; done steem/programs/util/get_dev_key xxx- block-init=0:21 | cut -d '"' -f 4 | sed 's/^private-key = /' >> testnet_datadir/config.ini
```

원하는 경우 Witness 의무를 다수의 노드에게 나누어줄 수 있습니다. 각 노드의 datadir에 있는 정의에 ```witness``` 와  ```private-key``` 를 넣고, ```p2p-seed-node``` 옵션을 이용하여 witness node와 다른 모든 노드를 연결합니다.

또한, 초기 블록 생성의 끝 timestamp와 일반적인 블록 생성의 시작의 timestamp 간 차이가 크므로, witness 는 ```--enable-stale-production``` 과 ```--required-participation=0``` 플래그를 명시해야합니다. 충분한 수의 witness 노드가 제 시간에 블록을 생성하는 한, 전환 후 128개의 블록이 생성되면 앞서 말한 플래그를 사용할 필요가 없습니다.